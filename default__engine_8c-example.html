<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>memcachedpublicAPI: default_engine.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>default_engine.c</h1><div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;assert.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;ctype.h&gt;</span>
<span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#include &lt;stddef.h&gt;</span>

<span class="preprocessor">#include &quot;default_engine.h&quot;</span>
<span class="preprocessor">#include &quot;util.h&quot;</span>
<span class="preprocessor">#include &quot;config_parser.h&quot;</span>

<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* default_get_info(<a name="_a0"></a><a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_initialize(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                            <span class="keyword">const</span> <span class="keywordtype">char</span>* config_str);
<span class="keyword">static</span> <span class="keywordtype">void</span> default_destroy(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_item_allocate(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                               <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                               <a name="_a1"></a><a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a> **<a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>,
                                               <span class="keyword">const</span> <span class="keywordtype">void</span>* key,
                                               <span class="keyword">const</span> <span class="keywordtype">size_t</span> nkey,
                                               <span class="keyword">const</span> <span class="keywordtype">size_t</span> nbytes,
                                               <span class="keyword">const</span> <span class="keywordtype">int</span> flags,
                                               <span class="keyword">const</span> <a name="a2"></a><a class="code" href="group___engine.html#gae315dc9bbd0d1cb8fbdacca8e31fd20e" title="Time relative to server start.">rel_time_t</a> exptime);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_item_delete(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                             <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                             <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>* <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>);
<span class="keyword">static</span> <span class="keywordtype">void</span> default_item_release(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle, <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>* <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_get(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                     <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                     <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>** <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>,
                                     <span class="keyword">const</span> <span class="keywordtype">void</span>* key,
                                     <span class="keyword">const</span> <span class="keywordtype">int</span> nkey);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_get_stats(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                  <span class="keyword">const</span> <span class="keywordtype">void</span> *cookie,
                  <span class="keyword">const</span> <span class="keywordtype">char</span> *stat_key,
                  <span class="keywordtype">int</span> nkey,
                  <a name="a3"></a><a class="code" href="group___engine.html#gab8d9bd9ba0b7b765633bf9b6cbd6aa30" title="Callback for any function producing stats.">ADD_STAT</a> add_stat);
<span class="keyword">static</span> <span class="keywordtype">void</span> default_reset_stats(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_store(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                       <span class="keyword">const</span> <span class="keywordtype">void</span> *cookie,
                                       <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>* <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>,
                                       uint64_t *cas,
                                       <a class="code" href="group___engine.html#ga319505a6161227851720785676bade01" title="Engine storage operations.">ENGINE_STORE_OPERATION</a> operation);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_arithmetic(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                            <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                            <span class="keyword">const</span> <span class="keywordtype">void</span>* key,
                                            <span class="keyword">const</span> <span class="keywordtype">int</span> nkey,
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> increment,
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> create,
                                            <span class="keyword">const</span> uint64_t delta,
                                            <span class="keyword">const</span> uint64_t initial,
                                            <span class="keyword">const</span> <a class="code" href="group___engine.html#gae315dc9bbd0d1cb8fbdacca8e31fd20e" title="Time relative to server start.">rel_time_t</a> exptime,
                                            uint64_t *cas,
                                            uint64_t *result);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_flush(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                       <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie, time_t when);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> initalize_configuration(<span class="keyword">struct</span> config *config,
                                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *cfg_str);
<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_unknown_command(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                                 <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                                 <a name="_a4"></a><a class="code" href="unionprotocol__binary__request__header.html" title="Definition of the header structure for a request packet.">protocol_binary_request_header</a> *request,
                                                 <a name="a5"></a><a class="code" href="group___engine.html#ga4f952131b9f47d1ad9f4a28290c9c8b0" title="Callback for adding a response backet.">ADD_RESPONSE</a> response);

<span class="keyword">struct </span>default_engine default_engine = {
   .engine = {
      .interface = {
         .interface = 1
      },
      .get_info = default_get_info,
      .initialize = default_initialize,
      .destroy = default_destroy,
      .allocate = default_item_allocate,
      .remove = default_item_delete,
      .release = default_item_release,
      .get = default_get,
      .get_stats = default_get_stats,
      .reset_stats = default_reset_stats,
      .store = default_store,
      .arithmetic = default_arithmetic,
      .flush = default_flush,
      .unknow_command = default_unknown_command,
   },
   .initialized = <span class="keyword">true</span>,
   .cache_lock = PTHREAD_MUTEX_INITIALIZER,
   .stats = {
      .lock = PTHREAD_MUTEX_INITIALIZER,
   },
   .config = {
      .use_cas = <span class="keyword">true</span>,
      .verbose = 0,
      .oldest_live = 0,
      .evict_to_free = <span class="keyword">true</span>,
      .maxbytes = 64 * 1024 * 1024,
      .preallocate = <span class="keyword">false</span>,
      .factor = 1.25,
      .chunk_size = 48,
      .item_size_max= 1024 * 1024,
   }
};

<a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> create_instance(uint64_t interface,
                                  <a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a> **handle) {
   <span class="keywordflow">if</span> (interface != 1) {
      <span class="keywordflow">return</span> <a name="a6"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a8269d8b3f2b991157ffe881e399c8e79" title="The engine does not support this.">ENGINE_ENOTSUP</a>;
   }

   *handle = (<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>*)&amp;default_engine;
   <span class="keywordflow">return</span> <a name="a7"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
}

<span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span>default_engine* get_handle(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle) {
   <span class="keywordflow">return</span> (<span class="keyword">struct</span> default_engine*)handle;
}

<span class="keyword">static</span> <span class="keyword">inline</span> hash_item* get_real_item(<a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>* <a class="code" href="structitem.html" title="Data common to any item stored in memcached.">item</a>) {
   hash_item it;
   ptrdiff_t offset = (caddr_t)&amp;it.item - (caddr_t)&amp;it;
   <span class="keywordflow">return</span> (hash_item*) (((caddr_t) item) - (offset));
}

<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* default_get_info(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle) {
   <span class="keywordflow">return</span> <span class="stringliteral">&quot;Default engine v0.1&quot;</span>;
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_initialize(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                            <span class="keyword">const</span> <span class="keywordtype">char</span>* config_str) {
   <span class="keyword">struct </span>default_engine* se = get_handle(handle);

   <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> ret = initalize_configuration(&amp;se-&gt;config, config_str);
   <span class="keywordflow">if</span> (ret != <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>) {
      <span class="keywordflow">return</span> ret;
   }

   ret = assoc_init();
   <span class="keywordflow">if</span> (ret != <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>) {
      <span class="keywordflow">return</span> ret;
   }

   ret = slabs_init(se, se-&gt;config.maxbytes, se-&gt;config.factor,
                    se-&gt;config.preallocate);
   <span class="keywordflow">if</span> (ret != <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>) {
      <span class="keywordflow">return</span> ret;
   }

   <span class="keywordflow">if</span> (start_assoc_maintenance_thread(se) != 0) {
      <span class="keywordflow">return</span> <a name="a8"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a86a31e7fdd6d4015d03238f75c7bd37d" title="Generic failue.">ENGINE_FAILED</a>;
   }

   <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> default_destroy(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle) {
   <span class="keyword">struct </span>default_engine* se = get_handle(handle);

   <span class="keywordflow">if</span> (se-&gt;initialized) {
      stop_assoc_maintenance_thread(se);

      pthread_mutex_destroy(&amp;se-&gt;cache_lock);
      pthread_mutex_destroy(&amp;se-&gt;stats.lock);
      se-&gt;initialized = <span class="keyword">false</span>;
      <span class="comment">/* @TODO clean up the other resources! */</span>
   }
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_item_allocate(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                               <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                               item **item,
                                               <span class="keyword">const</span> <span class="keywordtype">void</span>* key,
                                               <span class="keyword">const</span> <span class="keywordtype">size_t</span> nkey,
                                               <span class="keyword">const</span> <span class="keywordtype">size_t</span> nbytes,
                                               <span class="keyword">const</span> <span class="keywordtype">int</span> flags,
                                               <span class="keyword">const</span> <a class="code" href="group___engine.html#gae315dc9bbd0d1cb8fbdacca8e31fd20e" title="Time relative to server start.">rel_time_t</a> exptime) {
   <span class="keyword">struct </span>default_engine* engine = get_handle(handle);
   <span class="keywordtype">size_t</span> ntotal = <span class="keyword">sizeof</span>(hash_item) + nkey + nbytes;
   <span class="keywordflow">if</span> (engine-&gt;config.use_cas) {
      ntotal += <span class="keyword">sizeof</span>(uint64_t);
   }
   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span> = slabs_clsid(ntotal);
   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == 0) {
      <span class="keywordflow">return</span> <a name="a9"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a9381fefc09e75ace2d7879b1a9ae870a" title="The data is too big for the engine.">ENGINE_E2BIG</a>;
   }

   hash_item *it;
   it = item_alloc(engine, key, nkey, flags, exptime, nbytes);

   <span class="keywordflow">if</span> (it != NULL) {
      *item = &amp;it-&gt;item;
      <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
   } <span class="keywordflow">else</span> {
      <span class="keywordflow">return</span> <a name="a10"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a561301c14a22433e53f1cbe2d6082323" title="Could not allocate memory.">ENGINE_ENOMEM</a>;
   }
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_item_delete(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                             <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                             item* item) {
   item_unlink(get_handle(handle), get_real_item(item));
   <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> default_item_release(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle, item* item) {
   item_release(get_handle(handle), get_real_item(item));
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_get(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                     <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                     item** item,
                                     <span class="keyword">const</span> <span class="keywordtype">void</span>* key,
                                     <span class="keyword">const</span> <span class="keywordtype">int</span> nkey) {
   hash_item *it = item_get(get_handle(handle), key, nkey);
   <span class="keywordflow">if</span> (it != NULL) {
      *item = &amp;it-&gt;item;
      <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
   } <span class="keywordflow">else</span> {
      *item = NULL;
      <span class="keywordflow">return</span> <a name="a11"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a2f712a400c3121c42e2082b75c912da5" title="The key does not exists.">ENGINE_KEY_ENOENT</a>;
   }
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_get_stats(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                           <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                           <span class="keyword">const</span> <span class="keywordtype">char</span>* stat_key,
                                           <span class="keywordtype">int</span> nkey,
                                           <a class="code" href="group___engine.html#gab8d9bd9ba0b7b765633bf9b6cbd6aa30" title="Callback for any function producing stats.">ADD_STAT</a> add_stat)
{
   <span class="keyword">struct </span>default_engine* engine = get_handle(handle);
   <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> ret = <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;

   <span class="keywordflow">if</span> (stat_key == NULL) {
      <span class="keywordtype">char</span> val[128];
      <span class="keywordtype">int</span> len;

      pthread_mutex_lock(&amp;engine-&gt;stats.lock);
      len = sprintf(val, <span class="stringliteral">&quot;%llu&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)engine-&gt;stats.evictions);
      add_stat(<span class="stringliteral">&quot;evictions&quot;</span>, 9, val, len, cookie);
      len = sprintf(val, <span class="stringliteral">&quot;%llu&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)engine-&gt;stats.curr_items);
      add_stat(<span class="stringliteral">&quot;curr_items&quot;</span>, 10, val, len, cookie);
      len = sprintf(val, <span class="stringliteral">&quot;%llu&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)engine-&gt;stats.total_items);
      add_stat(<span class="stringliteral">&quot;total_items&quot;</span>, 11, val, len, cookie);
      len = sprintf(val, <span class="stringliteral">&quot;%llu&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)engine-&gt;stats.curr_bytes);
      add_stat(<span class="stringliteral">&quot;bytes&quot;</span>, 5, val, len, cookie);
      pthread_mutex_unlock(&amp;engine-&gt;stats.lock);
   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(stat_key, <span class="stringliteral">&quot;slabs&quot;</span>, 5) == 0) {
      slabs_stats(add_stat, cookie);
   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(stat_key, <span class="stringliteral">&quot;items&quot;</span>, 5) == 0) {
      item_stats(engine, add_stat, cookie);
   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp(stat_key, <span class="stringliteral">&quot;sizes&quot;</span>, 5) == 0) {
      item_stats_sizes(engine, add_stat, cookie);
   } <span class="keywordflow">else</span> {
      ret = <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a2f712a400c3121c42e2082b75c912da5" title="The key does not exists.">ENGINE_KEY_ENOENT</a>;
   }

   <span class="keywordflow">return</span> ret;
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_store(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                       <span class="keyword">const</span> <span class="keywordtype">void</span> *cookie,
                                       item* item,
                                       uint64_t *cas,
                                       <a class="code" href="group___engine.html#ga319505a6161227851720785676bade01" title="Engine storage operations.">ENGINE_STORE_OPERATION</a> operation) {
   <span class="keywordflow">return</span> store_item(get_handle(handle), get_real_item(item), cas, operation);
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_arithmetic(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                            <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                            <span class="keyword">const</span> <span class="keywordtype">void</span>* key,
                                            <span class="keyword">const</span> <span class="keywordtype">int</span> nkey,
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> increment,
                                            <span class="keyword">const</span> <span class="keywordtype">bool</span> create,
                                            <span class="keyword">const</span> uint64_t delta,
                                            <span class="keyword">const</span> uint64_t initial,
                                            <span class="keyword">const</span> <a class="code" href="group___engine.html#gae315dc9bbd0d1cb8fbdacca8e31fd20e" title="Time relative to server start.">rel_time_t</a> exptime,
                                            uint64_t *cas,
                                            uint64_t *result) {
   <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> ret = <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
   <span class="keyword">struct </span>default_engine *engine = get_handle(handle);
   hash_item *item = item_get(engine, key, nkey);

   <span class="keywordflow">if</span> (item == NULL) {
      <span class="keywordflow">if</span> (!create) {
         <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a2f712a400c3121c42e2082b75c912da5" title="The key does not exists.">ENGINE_KEY_ENOENT</a>;
      } <span class="keywordflow">else</span> {
         <span class="keywordtype">char</span> buffer[1023];
         <span class="keywordtype">int</span> len = snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;%llu\r\n&quot;</span>,
                            (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)initial);

         item = item_alloc(engine, key, nkey, 0, exptime, len);
         <span class="keywordflow">if</span> (item == NULL) {
            <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a561301c14a22433e53f1cbe2d6082323" title="Could not allocate memory.">ENGINE_ENOMEM</a>;
         }
         memcpy(<a name="a12"></a><a class="code" href="group___engine.html#ga6d25447921c853b31fdd9852f72848cf" title="Get the data from an item.">ITEM_data</a>(&amp;item-&gt;item), buffer, len);
         <span class="keywordflow">if</span> ((ret = store_item(engine, item, cas,
                               <a name="a13"></a><a class="code" href="group___engine.html#gga319505a6161227851720785676bade01accfb4a0fba17f4822ae1f255c742afe3" title="Store with add semantics.">OPERATION_ADD</a>)) == <a name="a14"></a><a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a80fcc05d0bffde2586a240b03e75c4c6" title="The key already exists.">ENGINE_KEY_EEXISTS</a>) {
            item_release(engine, item);
            <span class="keywordflow">return</span> default_arithmetic(handle, cookie, key, nkey, increment,
                                      create, delta, initial, exptime, cas,
                                      result);
         }

         *result = initial;
         *cas = <a name="a15"></a><a class="code" href="group___engine.html#gac0d2c2ceff296e9aeceb5d58811b8012" title="Get the CAS ID from an item.">ITEM_get_cas</a>(&amp;item-&gt;item);
         item_release(engine, item);
      }
   } <span class="keywordflow">else</span> {
      ret = add_delta(engine, item, increment, delta, cas, result);
      item_release(engine, item);
   }

   <span class="keywordflow">return</span> ret;
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_flush(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                       <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie, time_t when) {

   <span class="comment">/*</span>
<span class="comment">     If exptime is zero realtime() would return zero too, and</span>
<span class="comment">     realtime(exptime) - 1 would overflow to the max unsigned</span>
<span class="comment">     value.  So we process exptime == 0 the same way we do when</span>
<span class="comment">     no delay is given at all.</span>
<span class="comment">   */</span>
   <span class="comment">/* @todo fix locking here!!! */</span>
   <span class="keywordflow">if</span> (when &gt; 0)
      default_engine.config.oldest_live = <a name="a16"></a><a class="code" href="group___engine.html#ga1ff8f68d7b14e73348265f6e1ce933e8" title="Get the relative time for the given time_t value.">realtime</a>(when) - 1;
   <span class="keywordflow">else</span> <span class="comment">/* exptime == 0 */</span>
      default_engine.config.oldest_live = <a name="a17"></a><a class="code" href="group___engine.html#ga21b2a3d4ff751fe99cdca2d14babc559" title="The current time.">current_time</a> - 1;

   item_flush_expired(get_handle(handle));

   <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> default_reset_stats(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle) {
   <span class="keyword">struct </span>default_engine *engine = get_handle(handle);
   item_stats_reset(engine);

   pthread_mutex_lock(&amp;engine-&gt;stats.lock);
   default_engine.stats.evictions = 0;
   default_engine.stats.total_items = 0;
   pthread_mutex_unlock(&amp;engine-&gt;stats.lock);
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> initalize_configuration(<span class="keyword">struct</span> config *config,
                                                 <span class="keyword">const</span> <span class="keywordtype">char</span> *cfg_str) {
   <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> ret = <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;

   <span class="keywordflow">if</span> (cfg_str != NULL) {
      <span class="keyword">struct </span>config_item items[] = {
         { .key = <span class="stringliteral">&quot;use_cas&quot;</span>,
           .datatype = DT_BOOL,
           .value.dt_bool = &amp;config-&gt;use_cas },
         { .key = <span class="stringliteral">&quot;verbose&quot;</span>,
           .datatype = DT_SIZE,
           .value.dt_size = &amp;config-&gt;verbose },
         { .key = <span class="stringliteral">&quot;eviction&quot;</span>,
           .datatype = DT_BOOL,
           .value.dt_bool = &amp;config-&gt;evict_to_free },
         { .key = <span class="stringliteral">&quot;cache_size&quot;</span>,
           .datatype = DT_SIZE,
           .value.dt_size = &amp;config-&gt;maxbytes },
         { .key = <span class="stringliteral">&quot;preallocate&quot;</span>,
           .datatype = DT_BOOL,
           .value.dt_bool = &amp;config-&gt;preallocate },
         { .key = <span class="stringliteral">&quot;factor&quot;</span>,
           .datatype = DT_FLOAT,
           .value.dt_float = &amp;config-&gt;factor },
         { .key = <span class="stringliteral">&quot;chunk_size&quot;</span>,
           .datatype = DT_SIZE,
           .value.dt_size = &amp;config-&gt;chunk_size },
         { .key = <span class="stringliteral">&quot;item_size_max&quot;</span>,
           .datatype = DT_SIZE,
           .value.dt_size = &amp;config-&gt;item_size_max },
         { .key = <span class="stringliteral">&quot;config_file&quot;</span>,
           .datatype = DT_CONFIGFILE },
         { .key = NULL}
      };

      ret = parse_config(cfg_str, items, stderr);
   }

   <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942ad5c10635facfa57b4d23b37dc5de73c3" title="The command executed successfully.">ENGINE_SUCCESS</a>;
}

<span class="keyword">static</span> <a class="code" href="group___engine.html#ga2ae886fae640170aa47e2f5fad851942" title="Response codes for engine operations.">ENGINE_ERROR_CODE</a> default_unknown_command(<a class="code" href="structengine__interface.html" title="Generic opaque data structure for engines.">ENGINE_HANDLE</a>* handle,
                                                 <span class="keyword">const</span> <span class="keywordtype">void</span>* cookie,
                                                 <a class="code" href="unionprotocol__binary__request__header.html" title="Definition of the header structure for a request packet.">protocol_binary_request_header</a> *request,
                                                 <a class="code" href="group___engine.html#ga4f952131b9f47d1ad9f4a28290c9c8b0" title="Callback for adding a response backet.">ADD_RESPONSE</a> response)
{
    <span class="keywordflow">return</span> <a class="code" href="group___engine.html#gga2ae886fae640170aa47e2f5fad851942a8269d8b3f2b991157ffe881e399c8e79" title="The engine does not support this.">ENGINE_ENOTSUP</a>;
}
</pre></div> </div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Fri Nov 20 00:21:43 2009 for memcachedpublicAPI by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
